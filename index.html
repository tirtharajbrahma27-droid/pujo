<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বনfire Foodcourt - Business Calculator</title>
    <style>
        /* CSS Styling */
        :root {
            /* NEW LIGHT MODE PALETTE */
            --primary-color-light: #3b82f6; 
            --secondary-color-light: #e0e7ff; 
            --bg-color-light: #f8f9fa; 
            --text-color-light: #212529;
            --card-bg-light: #ffffff;
            --border-color-light: #dee2e6;
            
            /* NEW MODERN DARK THEME PALETTE (from your image) */
            --primary-color-dark: #22d3ee; /* Cyan Accent */
            --bg-color-dark: #111827; /* Dark Slate Background */
            --card-bg-dark: #1F2937; /* Lighter Slate for Cards */
            --text-color-dark: #f9fafb; /* Off-white */
            --text-muted-dark: #9ca3af; /* Muted gray */
            --border-color-dark: #374151;

            --success-color: #28a745;
            --danger-color: #e5534b;
        }

        /* Default to light mode variables */
        body {
            --primary-color: var(--primary-color-light);
            --secondary-color: var(--secondary-color-light);
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --text-muted: #6c757d;
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
        }

        body.dark-mode {
            --primary-color: var(--primary-color-dark);
            --secondary-color: var(--primary-color-dark); /* Use same for consistency */
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --text-muted: var(--text-muted-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; transition: background-color 0.3s, color 0.3s; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        /* Header */
        header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background-color: var(--card-bg); border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-title { display: flex; align-items: center; gap: 15px; }
        #logo-placeholder { width: 50px; height: 50px; border: 2px dashed var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; text-align: center; cursor: pointer; }
        #logo-img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; display: none; }
        header h1 { font-size: 1.8rem; font-weight: 600; color: var(--text-color); }
        .controls { display: flex; align-items: center; gap: 10px; }
        .control-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.9rem; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .control-btn:hover { background-color: var(--border-color); color: var(--text-color); transform: translateY(-1px); }
        
        /* Cloud Status */
        #cloud-status { cursor: default; border-style: dashed; }
        #cloud-status.connected { color: var(--success-color); border-color: var(--success-color); }
        #cloud-status.disconnected { color: var(--danger-color); border-color: var(--danger-color); }

        /* Dashboard & Summary Cards */
        #dashboard, .payment-summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card:hover { transform: translateY(-5px) scale(1.02); }
        body.light-mode .stat-card:hover { border-color: var(--primary-color-light); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        body.dark-mode .stat-card:hover { border-color: var(--primary-color-dark); box-shadow: 0 6px 20px rgba(34, 211, 238, 0.1); }
        .stat-card h3 { margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; text-transform: uppercase; }
        .stat-card p { font-size: 2rem; font-weight: 700; color: var(--text-color); }
        #profit-loss-display.profit, #payment-summary-paid { color: var(--success-color); }
        #profit-loss-display.loss, #payment-summary-due { color: var(--danger-color); }

        /* Navigation */
        nav { display: flex; gap: 10px; margin-bottom: 2rem; flex-wrap: wrap; }
        nav button { padding: 10px 20px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-muted); cursor: pointer; border-radius: 8px; transition: all 0.2s; font-size: 1rem; font-weight: 500; }
        nav button.active { color: white; border: none; background-color: var(--primary-color); }
        body.dark-mode nav button.active { color: var(--bg-color-dark); }

        /* Sub Navigation */
        .sub-nav { display: flex; gap: 10px; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .sub-nav button { padding: 8px 15px; font-size: 0.9rem; background-color: transparent; border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; border-radius: 20px; }
        body.dark-mode .sub-nav button.active { background-color: var(--primary-color-dark); color: #0D1117; border-color: var(--primary-color-dark); font-weight: 600; }
        body.light-mode .sub-nav button.active { background-color: var(--secondary-color-light); color: var(--primary-color-light); border-color: var(--secondary-color-light); font-weight: 600; }
        
        /* Main Sections */
        main section { display: none; padding: 2rem; background-color: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        main section.active { display: block; animation: slideUpFadeIn 0.5s ease-in-out; }
        .sub-content, .category-content { display: none; }
        .sub-content.active, .category-content.active { display: block; }
        section h2 { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; font-weight: 600; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); }
        td input[type="number"] { width: 80px; }
        .action-cell { width: 120px; text-align: right; }

        /* Forms & Inputs */
        .form-card { background-color: transparent; border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem; }
        .form-card h3 { margin-bottom: 1rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: center; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); outline: none; }
        body.light-mode input, body.light-mode select { background-color: #fff; }
        button.primary-btn { padding: 12px 15px; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.2s; background-color: var(--primary-color); }
        button.primary-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .checkbox-container { display: flex; align-items: center; gap: 8px; }
        .delete-btn, .action-btn { background-color: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .delete-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .action-btn { border-color: var(--success-color); color: var(--success-color); }
        .action-btn:hover { background-color: var(--success-color); color: white; }

        /* Custom Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-box { background: var(--card-bg); padding: 2rem; border-radius: 12px; text-align: center; max-width: 400px; width: 100%; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.2s ease, opacity 0.2s ease; transform: scale(0.95); opacity: 0; }
        .modal.show .modal-box { transform: scale(1); opacity: 1; }
        .modal-box h3 { font-weight: 600; color: var(--text-color); font-size: 1.25rem; }
        .modal-box p { color: var(--text-muted); margin-top: 0.5rem; }
        .modal .btn-group { display: flex; gap: 10px; margin-top: 1.5rem; }
        .modal .btn-group button { flex-grow: 1; }
        .modal .cancel-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); background-image: none; }
        .modal-box .danger-btn { background-image: none; background-color: var(--danger-color); }

        /* Slide-down Password Modal */
        #password-modal { align-items: flex-start; padding-top: 5vh; }
        #password-modal .modal-box { border-radius: 0 0 12px 12px; border-top: none; }
        #password-modal.show .modal-box { transform: translateY(0); }
        #password-modal .modal-box { transform: translateY(-120%); }
        .password-box .form-grid { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 1.5rem; }
        .password-box input { margin: 0; }

        /* Centered Modals */
        #confirm-modal, #alert-modal, #reset-confirm-modal { align-items: center; }

        /* Lock State */
        .locked .form-card, .locked .editable, .locked .action-cell, .locked .reset-btn { display: none; }
        
        /* ANIMATIONS */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .stat-card-animation { animation: fadeInDown 0.5s ease-in-out both; }
        .stat-card-animation:nth-child(1) { animation-delay: 0.0s; }
        .stat-card-animation:nth-child(2) { animation-delay: 0.05s; }
        .stat-card-animation:nth-child(3) { animation-delay: 0.1s; }
        .stat-card-animation:nth-child(4) { animation-delay: 0.15s; }
        .stat-card-animation:nth-child(5) { animation-delay: 0.2s; }
        .stat-card-animation:nth-child(6) { animation-delay: 0.25s; }
        .stat-card-animation:nth-child(7) { animation-delay: 0.3s; }
        .stat-card-animation:nth-child(8) { animation-delay: 0.35s; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            #dashboard, .payment-summary-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="dark-mode locked">

    <div class="container">
        <header><!-- Content generated by JS --></header>
        <div id="dashboard"><!-- Content generated by JS --></div>
        <nav><!-- Content generated by JS --></nav>
        <main><!-- Content generated by JS --></main>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal">
         <div class="modal-box password-box">
            <h3>Enter Password to Unlock</h3>
            <div class="form-grid">
                <input type="password" id="password-input" placeholder="••••••••">
                <button id="password-submit-btn" class="primary-btn">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-box confirm-box">
            <h3 id="confirm-title">Are you sure?</h3>
            <p id="confirm-message">This action cannot be undone.</p>
            <div class="btn-group">
                <button id="confirm-cancel-btn" class="primary-btn cancel-btn">Cancel</button>
                <button id="confirm-ok-btn" class="primary-btn danger-btn">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Reset Confirm Modal -->
    <div id="reset-confirm-modal" class="modal">
        <div class="modal-box confirm-box">
            <h3>Confirm Data Reset</h3>
            <p>This is irreversible. Please enter the reset password to proceed.</p>
            <input type="password" id="reset-password-input" placeholder="Enter Reset Password" style="margin-top: 1.5rem; text-align: center;">
            <div class="btn-group">
                <button id="reset-cancel-btn" class="primary-btn cancel-btn">Cancel</button>
                <button id="confirm-reset-btn" class="primary-btn danger-btn">Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-box alert-box">
            <h3 id="alert-title">Notification</h3>
            <p id="alert-message">This is an alert.</p>
            <div class="btn-group" style="justify-content: center;">
                <button id="alert-ok-btn" class="primary-btn" style="flex-grow: 0; padding: 10px 40px;">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDw_Csl5bWNMOCnpV4urWikIT3Ur3FgrSQ",
          authDomain: "pujo-ede94.firebaseapp.com",
          databaseURL: "https://pujo-ede94-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "pujo-ede94",
          storageBucket: "pujo-ede94.appspot.com",
          messagingSenderId: "401012511728",
          appId: "1:401012511728:web:bebc952fc7cbf97344c335",
          measurementId: "G-4EKFBQLGFC"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dataRef = ref(database, 'bonfireFoodcourt/data');
        const connectedRef = ref(database, '.info/connected'); 

        // --- PRE-FILL STATIC HTML to simplify JS ---
        document.querySelector('header').innerHTML = `<div class="header-title"><div id="logo-placeholder" title="Click to upload logo">Logo</div><input type="file" id="logo-upload" accept="image/*" style="display: none;"><img id="logo-img" src="" alt="Business Logo"><h1>বনfire Foodcourt</h1></div><div class="controls"><div id="cloud-status" class="control-btn">☁️ Connecting...</div><button class="control-btn" id="theme-toggle-btn">🌙 Dark</button><button class="control-btn reset-btn" id="reset-btn">🗑️ Reset</button><button class="control-btn" id="lock-btn">🔓 Unlock Edit</button></div>`;
        document.querySelector('#dashboard').innerHTML = `<div class="stat-card stat-card-animation"><h3>Total Investment</h3><p id="total-investment-display">0</p></div><div class="stat-card stat-card-animation"><h3>Total Sell</h3><p id="total-sell-display">0</p></div><div class="stat-card stat-card-animation"><h3>Snacks Sales</h3><p id="snacks-sell-display">0</p></div><div class="stat-card stat-card-animation"><h3>Ice-cream Sales</h3><p id="icecream-sell-display">0</p></div><div class="stat-card stat-card-animation"><h3>Snacks Stock Value</h3><p id="snacks-stock-value-display">0</p></div><div class="stat-card stat-card-animation"><h3>Ice-cream Stock Value</h3><p id="icecream-stock-value-display">0</p></div><div class="stat-card stat-card-animation"><h3>Total Expenditure</h3><p id="total-expenditure-display">0</p></div><div class="stat-card stat-card-animation"><h3>Profit / Loss</h3><p id="profit-loss-display">0</p></div>`;
        document.querySelector('nav').innerHTML = `<button class="nav-btn active" data-section="investors-section">Investors</button><button class="nav-btn" data-section="products-section">Product</button><button class="nav-btn" data-section="sell-section">Sell</button><button class="nav-btn" data-section="payment-section">Payments</button>`;
        document.querySelector('main').innerHTML = `<section id="investors-section" class="active"><h2>Investors and Shares</h2><table><thead><tr><th>Name</th><th>Investment</th><th>Share (%)</th><th>Profit/Loss Share</th><th class="action-cell">Action</th></tr></thead><tbody id="investor-list"></tbody></table><div class="form-card"><h3>Add New Investor</h3><div class="form-grid"><input type="text" id="investor-name" placeholder="Investor Name"><input type="number" id="investor-amount" placeholder="Amount"><button id="add-investor-btn" class="primary-btn">Add Investor</button></div></div></section><section id="products-section"><h2>Product Rate Chart</h2><div class="sub-nav"><button class="sub-nav-btn active" data-content="products-snacks">Snacks</button><button class="sub-nav-btn" data-content="products-icecream">Ice-cream</button></div><div id="products-snacks" class="sub-content active"><h3>Snacks</h3><table><thead><tr><th>Name</th><th>Stock</th><th>Cost Price</th><th>Selling Price</th><th>Profit (%)</th><th class="action-cell">Action</th></tr></thead><tbody id="snacks-product-list"></tbody></table><div class="form-card"><h3>Add New Snack</h3><div class="form-grid"><input type="text" id="snack-name" placeholder="Snack Name"><input type="number" id="snack-stock" placeholder="Stock Qty"><input type="number" id="snack-cost" placeholder="Cost Price"><input type="number" id="snack-selling" placeholder="Selling Price"></div><button id="add-snack-btn" class="primary-btn" style="margin-top: 1rem;">Add Snack</button></div></div><div id="products-icecream" class="sub-content"><h3>Ice-cream</h3><table><thead><tr><th>Name</th><th>Stock</th><th>Cost Price</th><th>Selling Price</th><th>Profit (%)</th><th class="action-cell">Action</th></tr></thead><tbody id="icecream-product-list"></tbody></table><div class="form-card"><h3>Add New Ice-cream</h3><div class="form-grid"><input type="text" id="icecream-name" placeholder="Name"><input type="number" id="icecream-stock" placeholder="Stock Qty"><input type="number" id="icecream-cost" placeholder="Cost Price"><input type="number" id="icecream-selling" placeholder="Selling Price"></div><button id="add-icecream-btn" class="primary-btn" style="margin-top: 1rem;">Add Ice-cream</button></div></div></section><section id="sell-section"><h2>Record Sells</h2><div class="sub-nav"><button class="sub-nav-btn active" data-content="sell-snacks">Snacks</button><button class="sub-nav-btn" data-content="sell-icecream">Ice-cream</button></div><div id="sell-snacks" class="sub-content active"><h3>Sell Snacks</h3><table><thead><tr><th>Name</th><th>Stock Left</th><th>Total Sold</th><th>Add to Sell</th></tr></thead><tbody id="snacks-sell-list"></tbody></table></div><div id="sell-icecream" class="sub-content"><h3>Sell Ice-cream</h3><table><thead><tr><th>Name</th><th>Stock Left</th><th>Total Sold</th><th>Add to Sell</th></tr></thead><tbody id="icecream-sell-list"></tbody></table></div><button id="record-sell-btn" class="primary-btn" style="margin-top: 1rem;">Update All Sells</button></section><section id="payment-section"><h2>Payments / Expenses</h2><div class="payment-summary-container"><div class="stat-card"><h3>Total Due</h3><p id="payment-summary-due">0</p></div><div class="stat-card"><h3>Total Paid</h3><p id="payment-summary-paid">0</p></div><div class="stat-card"><h3>Total Expenditure</h3><p id="payment-summary-expenditure">0</p></div></div><div class="sub-nav category-nav"><button class="sub-nav-btn active" data-content="payments-snacks">Snacks</button><button class="sub-nav-btn" data-content="payments-icecream">Ice-cream</button><button class="sub-nav-btn" data-content="payments-general">General Expenses</button></div><div id="payments-snacks" class="category-content active"><div class="sub-nav status-nav"><button class="sub-nav-btn active" data-content="snacks-payments-due">Due</button><button class="sub-nav-btn" data-content="snacks-payments-paid">Paid</button><button class="sub-nav-btn" data-content="snacks-payments-all">All</button></div><div id="snacks-payments-due" class="sub-content active"><h3>Due Snacks Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="snacks-due-payment-list"></tbody></table></div><div id="snacks-payments-paid" class="sub-content"><h3>Paid Snacks Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="snacks-paid-payment-list"></tbody></table></div><div id="snacks-payments-all" class="sub-content"><h3>All Snacks Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th>Status</th><th class="action-cell">Action</th></tr></thead><tbody id="snacks-all-payment-list"></tbody></table></div></div><div id="payments-icecream" class="category-content"><div class="sub-nav status-nav"><button class="sub-nav-btn active" data-content="icecream-payments-due">Due</button><button class="sub-nav-btn" data-content="icecream-payments-paid">Paid</button><button class="sub-nav-btn" data-content="icecream-payments-all">All</button></div><div id="icecream-payments-due" class="sub-content active"><h3>Due Ice-cream Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="icecream-due-payment-list"></tbody></table></div><div id="icecream-payments-paid" class="sub-content"><h3>Paid Ice-cream Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="icecream-paid-payment-list"></tbody></table></div><div id="icecream-payments-all" class="sub-content"><h3>All Ice-cream Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th>Status</th><th class="action-cell">Action</th></tr></thead><tbody id="icecream-all-payment-list"></tbody></table></div></div><div id="payments-general" class="category-content"><div class="sub-nav status-nav"><button class="sub-nav-btn active" data-content="general-payments-due">Due</button><button class="sub-nav-btn" data-content="general-payments-paid">Paid</button><button class="sub-nav-btn" data-content="general-payments-all">All</button></div><div id="general-payments-due" class="sub-content active"><h3>Due General Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="general-due-payment-list"></tbody></table></div><div id="general-payments-paid" class="sub-content"><h3>Paid General Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th class="action-cell">Action</th></tr></thead><tbody id="general-paid-payment-list"></tbody></table></div><div id="general-payments-all" class="sub-content"><h3>All General Payments</h3><table><thead><tr><th>Name</th><th>Description</th><th>Qty</th><th>Amount</th><th>Status</th><th class="action-cell">Action</th></tr></thead><tbody id="general-all-payment-list"></tbody></table></div></div><div class="form-card"><h3>Add New Payment</h3><div class="form-grid"><select id="payment-category"><option value="Snacks">Snacks</option><option value="Ice-cream">Ice-cream</option><option value="General">General Expense</option></select><input type="text" id="payment-desc" placeholder="e.g., Vendor payment, Rent"><input type="number" id="payment-qty" placeholder="Quantity (optional)"><input type="number" id="payment-amount" placeholder="Amount"><div class="checkbox-container"><input type="checkbox" id="payment-is-paid"><label for="payment-is-paid">Mark as Paid</label></div></div><button id="add-payment-btn" class="primary-btn" style="margin-top: 1rem;">Add Payment</button></div></section>`;
        
        const initialState = { theme: 'light', logo: null, investors: [], products: { snacks: [], iceCreams: [] }, sells: { snacks: {}, iceCreams: {} }, payments: [] };
        let state = { ...initialState };
        let actionToConfirm = null; 
        let previousMetrics = {}; 

        // --- DOM ELEMENTS ---
        const body = document.body;
        const lockBtn = document.getElementById('lock-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const confirmModal = document.getElementById('confirm-modal');
        const alertModal = document.getElementById('alert-modal');
        const resetConfirmModal = document.getElementById('reset-confirm-modal');
        const resetPasswordInput = document.getElementById('reset-password-input');
        const cloudStatusEl = document.getElementById('cloud-status');

        // --- DATA BINDING (FIREBASE) ---
        async function saveStateToDB(newState) {
            try {
                await set(dataRef, newState);
            } catch (error) {
                showAlert('Could not save data. Check connection.', 'Save Error');
            }
        }
        
        function parseFirebaseData(data) {
            const ensureArray = (value) => (value && !Array.isArray(value)) ? Object.values(value) : (value || []);
            const newState = { ...initialState, ...data };
            newState.investors = ensureArray(data.investors);
            newState.payments = ensureArray(data.payments);
            newState.products = data.products || { snacks: [], iceCreams: [] };
            newState.products.snacks = ensureArray(data.products?.snacks);
            newState.products.iceCreams = ensureArray(data.products?.iceCreams);
            newState.sells = data.sells || { snacks: {}, iceCreams: {} };
            return newState;
        }

        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            state = data ? parseFirebaseData(data) : { ...initialState };
            renderAll();
        });

        onValue(connectedRef, (snap) => {
            if (snap.val() === true) {
                cloudStatusEl.textContent = '☁️ Cloud: Connected';
                cloudStatusEl.classList.add('connected');
                cloudStatusEl.classList.remove('disconnected');
            } else {
                cloudStatusEl.textContent = '☁️ Cloud: Disconnected';
                cloudStatusEl.classList.add('disconnected');
                cloudStatusEl.classList.remove('connected');
            }
        });
        
        // --- ANIMATIONS ---
        function animateValue(element, start, end, duration) {
            if (start === end) {
                element.textContent = end.toFixed(2);
                return;
            }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const easedProgress = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
                const currentValue = start + easedProgress * (end - start);
                element.textContent = currentValue.toFixed(2);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- CALCULATIONS ---
        function calculateMetrics() {
            const totalInvestment = state.investors.reduce((sum, inv) => sum + inv.amount, 0);
            let snacksSell = 0, iceCreamsSell = 0, snacksStockValue = 0, iceCreamsStockValue = 0;
            (state.products.snacks || []).forEach(p => { const soldQty = state.sells.snacks?.[p.name] || 0; snacksSell += soldQty * p.sellingPrice; snacksStockValue += p.stock * p.costPrice; });
            (state.products.iceCreams || []).forEach(p => { const soldQty = state.sells.iceCreams?.[p.name] || 0; iceCreamsSell += soldQty * p.sellingPrice; iceCreamsStockValue += p.stock * p.costPrice; });
            const totalSell = snacksSell + iceCreamsSell;
            const totalExpenditure = state.payments.reduce((sum, p) => sum + p.amount, 0);
            const profitLoss = totalSell - totalExpenditure;
            return { totalInvestment, totalSell, snacksSell, iceCreamsSell, snacksStockValue, iceCreamsStockValue, totalExpenditure, profitLoss };
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() { renderTheme(); updateDashboard(); renderInvestors(); renderProducts(); renderSellSection(); renderPayments(); }
        function renderTheme() { 
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (state.theme === 'dark') { body.classList.add('dark-mode'); body.classList.remove('light-mode'); themeToggleBtn.innerHTML = '☀️ Light'; } 
            else { body.classList.add('light-mode'); body.classList.remove('dark-mode'); themeToggleBtn.innerHTML = '🌙 Dark'; } 
        }
        function updateDashboard() {
            const logoImg = document.getElementById('logo-img'), logoPlaceholder = document.getElementById('logo-placeholder');
            if (state.logo) { logoImg.src = state.logo; logoImg.style.display = 'block'; logoPlaceholder.style.display = 'none'; } else { logoImg.style.display = 'none'; logoPlaceholder.style.display = 'flex'; }
            
            const metrics = calculateMetrics();
            const duration = 800;
            
            for (const key in metrics) {
                const elementId = `${key.replace(/([A-Z])/g, "-$1").toLowerCase()}-display`;
                const element = document.getElementById(elementId);
                if (element) {
                    const startValue = parseFloat(previousMetrics[key]) || 0;
                    const endValue = metrics[key];
                    if(startValue !== endValue) {
                         animateValue(element, startValue, endValue, duration);
                    } else {
                        element.textContent = endValue.toFixed(2);
                    }
                    if (key === 'profitLoss') {
                        element.classList.toggle('profit', endValue > 0);
                        element.classList.toggle('loss', endValue < 0);
                    }
                }
            }
            previousMetrics = metrics; 
        }
        function renderInvestors() {
            const listEl = document.getElementById('investor-list'); listEl.innerHTML = ''; const metrics = calculateMetrics();
            state.investors.forEach((investor, index) => {
                const sharePercent = metrics.totalInvestment > 0 ? (investor.amount / metrics.totalInvestment) * 100 : 0;
                const profitLossShare = metrics.profitLoss * (sharePercent / 100);
                listEl.innerHTML += `<tr><td>${investor.name}</td><td>${investor.amount.toFixed(2)}</td><td>${sharePercent.toFixed(2)}%</td><td class="${profitLossShare >= 0 ? 'profit' : 'loss'}">${profitLossShare.toFixed(2)}</td><td class="action-cell"><button class="delete-btn" data-type="investor" data-index="${index}">Delete</button></td></tr>`;
            });
        }
        function renderProducts() {
            const renderList = (cat, elId) => {
                const listEl = document.getElementById(elId); listEl.innerHTML = '';
                (state.products[cat] || []).forEach((p, index) => {
                    const profitPercent = p.costPrice > 0 ? ((p.sellingPrice - p.costPrice) / p.costPrice) * 100 : 0;
                    listEl.innerHTML += `<tr><td>${p.name}</td><td>${p.stock}</td><td>${p.costPrice.toFixed(2)}</td><td>${p.sellingPrice.toFixed(2)}</td><td>${profitPercent.toFixed(2)}%</td><td class="action-cell"><button class="delete-btn" data-type="product" data-category="${cat}" data-index="${index}">Delete</button></td></tr>`;
                });
            };
            renderList('snacks', 'snacks-product-list'); renderList('iceCreams', 'icecream-product-list');
        }
        function renderSellSection() {
             const renderList = (cat, elId) => {
                const listEl = document.getElementById(elId); listEl.innerHTML = '';
                (state.products[cat] || []).forEach(p => {
                    const soldQty = state.sells[cat]?.[p.name] || 0;
                    listEl.innerHTML += `<tr><td>${p.name}</td><td>${p.stock}</td><td>${soldQty}</td><td class="editable"><input type="number" class="sell-input" data-category="${cat}" data-name="${p.name}" placeholder="0"></td></tr>`;
                });
            };
            renderList('snacks', 'snacks-sell-list'); renderList('iceCreams', 'icecream-sell-list');
        }
        function renderPayments() {
            const totalDue = state.payments.filter(p => p.status === 'due').reduce((sum, p) => sum + p.amount, 0);
            const totalPaid = state.payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('payment-summary-due').textContent = totalDue.toFixed(2);
            document.getElementById('payment-summary-paid').textContent = totalPaid.toFixed(2);
            document.getElementById('payment-summary-expenditure').textContent = (totalDue + totalPaid).toFixed(2);
            document.querySelectorAll('#payment-section tbody').forEach(tbody => tbody.innerHTML = '');
            state.payments.forEach(p => {
                const cat = p.category.toLowerCase().replace('-', '');
                const qtyCell = p.quantity ? p.quantity : '-';
                const rowHtml = `<td>${p.date}</td><td>${p.description}</td><td>${qtyCell}</td><td>${p.amount.toFixed(2)}</td>`;
                const statusCell = `<span style="color:${p.status === 'paid' ? 'var(--success-color)' : 'var(--danger-color)'}">${p.status.toUpperCase()}</span>`;
                if (p.status === 'due') { document.getElementById(`${cat}-due-payment-list`).innerHTML += `<tr>${rowHtml}<td class="action-cell"><button class="action-btn" data-id="${p.id}">Mark Paid</button> <button class="delete-btn" data-type="payment" data-id="${p.id}">Del</button></td></tr>`; } 
                else { document.getElementById(`${cat}-paid-payment-list`).innerHTML += `<tr>${rowHtml}<td class="action-cell"><button class="delete-btn" data-type="payment" data-id="${p.id}">Delete</button></td></tr>`; }
                document.getElementById(`${cat}-all-payment-list`).innerHTML += `<tr>${rowHtml}<td>${statusCell}</td><td class="action-cell"><button class="delete-btn" data-type="payment" data-id="${p.id}">Delete</button></td></tr>`;
            });
        }
        
        // --- Custom Alert Function ---
        function showAlert(message, title = 'Notification') {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.add('show');
        }

        // --- EVENT LISTENERS (Consolidated Logic) ---
        document.querySelector('body').addEventListener('click', (e) => {
            if (e.target.matches('.nav-btn, .sub-nav-btn')) {
                const isSubNav = e.target.classList.contains('sub-nav-btn');
                const container = e.target.closest(isSubNav ? '.category-content, #products-section, #sell-section, #payment-section' : 'body');
                const contentSelector = isSubNav ? '.sub-content, .category-content' : 'main section';
                container.querySelectorAll(isSubNav ? '.sub-nav-btn' : '.nav-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                container.querySelectorAll(contentSelector).forEach(c => c.classList.remove('active'));
                document.getElementById(e.target.dataset.section || e.target.dataset.content).classList.add('active');
            }
            if (e.target.id === 'add-investor-btn') { const name = document.getElementById('investor-name').value; const amount = parseFloat(document.getElementById('investor-amount').value); if (name && amount > 0) { const newState = JSON.parse(JSON.stringify(state)); newState.investors.push({ name, amount }); saveStateToDB(newState); e.target.closest('.form-grid').querySelectorAll('input').forEach(i => i.value=''); } }
            if (e.target.id === 'add-snack-btn') { const name = document.getElementById('snack-name').value; const stock = parseInt(document.getElementById('snack-stock').value) || 0; const cost = parseFloat(document.getElementById('snack-cost').value); const selling = parseFloat(document.getElementById('snack-selling').value); if (name && cost >= 0 && selling >= 0) { const newState = JSON.parse(JSON.stringify(state)); newState.products.snacks.push({ name, stock, costPrice: cost, sellingPrice: selling }); saveStateToDB(newState); e.target.closest('.form-card').querySelectorAll('input').forEach(i => i.value=''); } }
            if (e.target.id === 'add-icecream-btn') { const name = document.getElementById('icecream-name').value; const stock = parseInt(document.getElementById('icecream-stock').value) || 0; const cost = parseFloat(document.getElementById('icecream-cost').value); const selling = parseFloat(document.getElementById('icecream-selling').value); if (name && cost >= 0 && selling >= 0) { const newState = JSON.parse(JSON.stringify(state)); newState.products.iceCreams.push({ name, stock, costPrice: cost, sellingPrice: selling }); saveStateToDB(newState); e.target.closest('.form-card').querySelectorAll('input').forEach(i => i.value=''); } }
            if (e.target.id === 'add-payment-btn') { const cat = document.getElementById('payment-category').value; const desc = document.getElementById('payment-desc').value; const qty = document.getElementById('payment-qty').value; const amount = parseFloat(document.getElementById('payment-amount').value); const isPaid = document.getElementById('payment-is-paid').checked; if(desc && amount > 0) { const newState = JSON.parse(JSON.stringify(state)); newState.payments.push({ id: Date.now(), category:cat, description: desc, quantity: qty, amount, status: isPaid ? 'paid' : 'due', date: new Date().toLocaleDateString() }); saveStateToDB(newState); e.target.closest('.form-card').querySelectorAll('input, select').forEach(i => { if(i.type === 'checkbox') i.checked=false; else i.value=''; }); } }
            if (e.target.id === 'record-sell-btn') { const newState = JSON.parse(JSON.stringify(state)); document.querySelectorAll('.sell-input').forEach(input => { const qty = parseInt(input.value) || 0; if (qty !== 0) { const category = input.dataset.category; const name = input.dataset.name; newState.sells[category][name] = (newState.sells[category][name] || 0) + qty; const product = newState.products[category].find(p => p.name === name); if (product) product.stock -= qty; input.value = ''; } }); saveStateToDB(newState); showAlert('Sells have been updated!', 'Success'); }
            
            // Actions: Delete, Mark as Paid, Reset
            if (e.target.matches('.delete-btn')) {
                actionToConfirm = { type: e.target.dataset.type, index: e.target.dataset.index, category: e.target.dataset.category, id: e.target.dataset.id };
                document.getElementById('confirm-message').textContent = `Are you sure you want to delete this ${actionToConfirm.type}?`;
                confirmModal.classList.add('show');
            }
            if (e.target.id === 'reset-btn') {
                resetConfirmModal.classList.add('show');
                resetPasswordInput.focus();
            }
            if (e.target.matches('.action-btn')) { const newState = JSON.parse(JSON.stringify(state)); const payment = newState.payments.find(p => p.id === parseInt(e.target.dataset.id)); if (payment) payment.status = 'paid'; saveStateToDB(newState); }
            
            // Custom Modal Actions
            if (e.target.id === 'confirm-ok-btn') {
                if (!actionToConfirm) return;
                let newState = JSON.parse(JSON.stringify(state));
                const { type, index, category, id } = actionToConfirm;
                if (type === 'investor') newState.investors.splice(index, 1);
                if (type === 'product') newState.products[category].splice(index, 1);
                if (type === 'payment') newState.payments = newState.payments.filter(p => p.id !== parseInt(id));
                saveStateToDB(newState);
                confirmModal.classList.remove('show'); 
                actionToConfirm = null;
            }
            if (e.target.id === 'confirm-reset-btn') {
                if (resetPasswordInput.value === '2025') {
                    saveStateToDB(initialState);
                    resetConfirmModal.classList.remove('show');
                    resetPasswordInput.value = '';
                } else {
                    showAlert('Incorrect reset password.', 'Error');
                }
            }
            if (e.target.id === 'confirm-cancel-btn' || e.target.id === 'confirm-modal') { confirmModal.classList.remove('show'); actionToConfirm = null; }
            if (e.target.id === 'reset-cancel-btn' || e.target.id === 'reset-confirm-modal') { resetConfirmModal.classList.remove('show'); resetPasswordInput.value = ''; }
            if (e.target.id === 'alert-ok-btn' || e.target.id === 'alert-modal') { alertModal.classList.remove('show'); }

            // Other Controls
            if (e.target.id === 'theme-toggle-btn') { const newTheme = state.theme === 'light' ? 'dark' : 'light'; const newState = {...state, theme: newTheme }; saveStateToDB(newState); }
            if (e.target.id === 'lock-btn') { if (body.classList.contains('locked')) { passwordModal.classList.add('show'); passwordInput.focus(); } else { body.classList.add('locked'); lockBtn.innerHTML = `🔓 Unlock Edit`; } }
            if (e.target.id === 'password-submit-btn') { if (passwordInput.value === '9733') { body.classList.remove('locked'); lockBtn.innerHTML = `🔒 Lock`; passwordModal.classList.remove('show'); passwordInput.value = ''; } else { showAlert('The password you entered is incorrect.', 'Wrong Password'); } }
            if (e.target.id === 'password-modal') { passwordModal.classList.remove('show'); passwordInput.value = ''; }
            if (e.target.matches('#logo-placeholder, #logo-img')) { document.getElementById('logo-upload').click(); }
        });
        document.getElementById('logo-upload').addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { const newState = {...state, logo: ev.target.result }; saveStateToDB(newState); }; reader.readAsDataURL(file); }});
        
        // Keyboard event listeners for password modals
        passwordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('password-submit-btn').click();
            }
        });
        resetPasswordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('confirm-reset-btn').click();
            }
        });

        // --- INITIALIZATION ---
        if (body.classList.contains('locked')) { lockBtn.innerHTML = `🔓 Unlock Edit`; } else { lockBtn.innerHTML = `🔒 Lock`; }
    </script>
</body>
</html>